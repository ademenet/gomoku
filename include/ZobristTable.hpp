#ifndef ZOBRISTTABLE_HPP
# define ZOBRISTTABLE_HPP

# include <iostream>
# include <cstdlib>
# include <random>
# include <cmath>
# include <thread>
# include <array>
# include <unordered_map>
# include "BitBoard.hpp"

# define SIZE 361   // the number of cells on the board (19*19)
# define S 3        // the number of states

typedef struct  s_stored {
    int         score;
    int         move;
    int8_t      depth;          /* the actual depth in the search tree */
    int8_t      max_id_depth;   /* the iterative deepening max depth at which the node was evaluated */
    uint8_t     flag;
}               t_stored;


namespace ZobristTable {
    enum flag {
        exact,
        lowerbound,
        upperbound
    };

    /* initialization of Zobrist Hashing */
    static const std::array<std::array<uint64_t, S>, SIZE>   _init_zobrist_table_x64(void) {
        std::array<std::array<uint64_t, S>, SIZE> table;
        /* set up random generator 64-bit */
        std::random_device  rd;
        std::mt19937_64     e2(rd());
        std::uniform_int_distribution<unsigned long long>   dist(std::llround(std::pow(2, 61)), std::llround(std::pow(2, 62)));

        for (int n = 0; n < SIZE; n++) {
            for (int s = 0; s < S; s++)
                table[n][s] = dist(e2);
        }
        return (table);
    }
    static const std::array<std::array<uint64_t, S>, SIZE> _table = _init_zobrist_table_x64();

    // static const uint64_t _table[SIZE][S] = {
    //     { 350767400, 505080785, 2037380551 },   { 628169242, 610841642, 1443644434 },   { 1061758432, 1532343701, 1476687883 }, { 224741202, 1949130588, 1322241178 },
    //     { 746699490, 2031379009, 691984257 },   { 1555458894, 1279196527, 997239172 },  { 1636382616, 2007043630, 1856645981 }, { 1711611757, 1515348334, 1450879765 },
    //     { 259398670, 321643280, 642267461 },    { 1336407205, 464430462, 1727201636 },  { 1541439753, 1882694910, 1429297472 }, { 450536562, 140658212, 1810557384 },
    //     { 194674898, 1283416305, 1052087667 },  { 57069871, 1395615335, 1290542811 },   { 568189777, 1853287477, 1099809851 },  { 1112416028, 383551814, 1756913251 },
    //     { 540863307, 2138806645, 194515382 },   { 749914540, 232149537, 1906965407 },   { 1321647621, 1508205226, 1655747841 }, { 1060865861, 1563288433, 1873756033 },
    //     { 1517447023, 216323789, 64107352 },    { 1562957917, 613740915, 779601864 },   { 970797901, 1767055848, 1356282973 },  { 1656497953, 783096363, 1720784125 },
    //     { 1056514726, 1448206486, 426755104 },  { 2025135595, 985623862, 1838879323 },  { 1607617684, 1738652081, 715540638 },  { 183079666, 1823363958, 686399416 },
    //     { 32833028, 2068887964, 1892282371 },   { 1504480974, 1339270240, 1338819473 }, { 205229445, 432545033, 552224536 },    { 1960937865, 51166546, 962679822 },
    //     { 617971856, 1022066900, 156695947 },   { 773830007, 599961417, 1115812854 },   { 1639431574, 1711273208, 120322585 },  { 1479574268, 1491573663, 1301942610 },
    //     { 1038566987, 448267693, 662482575 },   { 1789411977, 1286104851, 1141323702 }, { 903524510, 679571633, 1242401085 },   { 1051535814, 1519494735, 272481021 },
    //     { 1153384543, 1746616379, 1427511010 }, { 490240786, 1729620410, 1391585078 },  { 126006469, 371848541, 481015817 },    { 1304389011, 1353039301, 827193824 },
    //     { 1984952937, 2093039661, 1935444567 }, { 1082036460, 895260424, 1371515286 },  { 2115428551, 268396925, 1231459775 },  { 1844532286, 2127686357, 126912255 },
    //     { 563008314, 667784716, 708182590 },    { 1070418456, 1052479073, 192979572 },  { 707359634, 123898846, 1456250779 },   { 335717794, 969423089, 135427034 },
    //     { 1936978265, 1089094982, 1416239093 }, { 21692703, 1664522978, 368221777 },    { 1803019032, 199128007, 964891623 },   { 1284489264, 1905440404, 1460725964 },
    //     { 388224444, 832910722, 1432093508 },   { 198873380, 980342928, 1129051112 },   { 796534492, 2089635293, 552806413 },   { 1003126369, 1798254833, 1731614000 },
    //     { 538113856, 1025940275, 832000162 },   { 1160697117, 94996071, 1018615576 },   { 132351948, 1793615391, 1065923598 },  { 669328312, 881596798, 1507703333 },
    //     { 1810366778, 1286127150, 1516102995 }, { 1249565310, 1201581157, 38289311 },   { 1430839524, 598000762, 375338974 },   { 1162664779, 953236600, 819529580 },
    //     { 2021022849, 582178544, 739293276 },   { 2109191837, 674643430, 18471850 },    { 1218737782, 626876988, 366765134 },   { 943540248, 1061698688, 528226293 },
    //     { 201909753, 473056411, 674638483 },    { 2082811268, 1825535176, 670838343 },  { 490884051, 1803557030, 651325805 },   { 1108655876, 1611186560, 1591208897 },
    //     { 834075788, 1686004947, 638422064 },   { 1131329236, 430258914, 784128149 },   { 1882142251, 730692247, 1433101783 },  { 2112565776, 1545861381, 1035069061 },
    //     { 1788167527, 1845470171, 710850376 },  { 810741171, 343120782, 837390879 },    { 1568164562, 74993903, 1997110579 },   { 268098643, 513201495, 1083200113 },
    //     { 1125423572, 2105495475, 826913059 },  { 1561102876, 1648321533, 800958831 },  { 1287573221, 50414528, 1208415178 },   { 1081046967, 1444720749, 1971515461 },
    //     { 1735163464, 64413188, 260692628 },    { 594358916, 1443859015, 373254005 },   { 480329148, 500961363, 1521731701 },   { 1361946584, 208043915, 490702089 },
    //     { 892805343, 911158212, 130182327 },    { 1836017243, 749279358, 294063898 },   { 972061939, 1536906044, 846575392 },   { 1313451969, 1202835470, 1792175079 },
    //     { 480919931, 1840316656, 2142553298 },  { 887486590, 1713189715, 118801029 },   { 1676586340, 1253684093, 1706490334 }, { 1338937853, 47358458, 1384654216 },
    //     { 1750609420, 1966558040, 20167303 },   { 1796928942, 922200433, 1033197032 },  { 389747182, 655764524, 548278464 },    { 63815171, 947239144, 952017997 },
    //     { 1813305429, 1283910626, 770206126 },  { 1970419213, 490392504, 2132061189 },  { 640269681, 2119457097, 1404176490 },  { 1296470547, 1411400967, 311687607 },
    //     { 820995816, 894247537, 1527792653 },   { 149151792, 680752095, 1755073096 },   { 1825632927, 166255753, 384215924 },   { 33708139, 1744493012, 99820193 },
    //     { 493255444, 857369888, 200436246 },    { 1477628026, 993339074, 511944940 },   { 1439116698, 126027125, 719013933 },   { 576690262, 839534523, 1089167271 },
    //     { 483716669, 1600451988, 1563883641 },  { 1139998654, 108279244, 930604899 },   { 553136392, 106632481, 1170746569 },   { 1492411369, 348881823, 1026442851 },
    //     { 688860406, 592502665, 310619516 },    { 49459555, 190569496, 1003401595 },    { 2129010921, 914022933, 1032907940 },  { 1973428879, 1681725085, 1721225428 },
    //     { 2031043306, 1492274877, 202344426 },  { 1336154581, 513546188, 434004423 },   { 1457872149, 1816279620, 1879014882 }, { 1856092639, 1001527351, 693363071 },
    //     { 1106865675, 1588049411, 1419685761 }, { 2115266957, 1847453861, 1838473501 }, { 1229418271, 1892712910, 150615359 },  { 1656602547, 393524074, 1856962605 },
    //     { 590660384, 1559657454, 977434096 },   { 1632435569, 93534111, 69773973 },     { 165092949, 168321919, 750529534 },    { 1978419107, 1800624848, 762266812 },
    //     { 1678354929, 913588358, 171456856 },   { 1899808165, 1288965559, 1976602824 }, { 1339127525, 1087692115, 1460573541 }, { 2121418377, 7671098, 79125266 },
    //     { 565968169, 1021943820, 235574034 },   { 1480428017, 808147577, 1849743011 },  { 1657511905, 644718451, 1728006842 },  { 42151466, 1917569199, 1298437064 },
    //     { 102913834, 948472203, 201204140 },    { 1498720602, 1161462151, 68020627 },   { 761377785, 1768863669, 1675559462 },  { 1174814723, 1146398943, 303754117 },
    //     { 626815500, 1480819965, 953166672 },   { 1791733331, 1646395883, 648813986 },  { 1842186883, 1363203782, 2010417878 }, { 585573648, 1966231382, 972477238 },
    //     { 2074385396, 1945825174, 1602722902 }, { 1076429593, 1149927223, 1621497608 }, { 942817226, 1794769816, 1140991750 },  { 1766858187, 181678193, 1891127364 },
    //     { 1419631148, 1197386266, 401716625 },  { 2110213854, 671813973, 1855911932 },  { 111868449, 1124831218, 739736385 },   { 966590212, 1915387176, 1132398502 },
    //     { 1221543400, 536258480, 2054890548 },  { 713429182, 1203060673, 1282194606 },  { 1993829044, 949914720, 823267242 },   { 415398673, 136160714, 1383036143 },
    //     { 325460273, 369959402, 942511349 },    { 948862371, 316306775, 1145941100 },   { 1198721404, 1366544521, 176159782 },  { 1484990508, 180522522, 1795117690 },
    //     { 545259127, 857425740, 1139140810 },   { 722880665, 1140345576, 1644030004 },  { 1687674926, 788471706, 1869860752 },  { 473968666, 974522739, 2093382351 },
    //     { 1252584456, 404760451, 1728189908 },  { 971458081, 2125282873, 533745960 },   { 629156201, 18792379, 163417744 },     { 2077922542, 1265095880, 230866213 },
    //     { 1812975409, 32231780, 553647416 },    { 105478261, 1099123852, 320249070 },   { 832100108, 693005892, 1546209163 },   { 437790194, 660815936, 1695497715 },
    //     { 1269583962, 500132742, 480000436 },   { 1418749720, 1415611399, 209457880 },  { 632891727, 524752098, 1940656504 },   { 632232092, 175684888, 2093381638 },
    //     { 1240601065, 863370732, 124889945 },   { 933782496, 271917996, 280557956 },    { 1610961327, 2100685160, 1584327440 }, { 1141544927, 326685791, 1639887605 },
    //     { 785851637, 784034009, 299931271 },    { 800752188, 2109491614, 1418028175 },  { 26022819, 1426338592, 112764283 },    { 1148727727, 788921159, 833882735 },
    //     { 588846823, 1143908785, 1401341551 },  { 894291008, 110926103, 319207525 },    { 506722469, 1711876128, 1663664437 },  { 971108719, 548523033, 2026802707 },
    //     { 1087487835, 174723228, 963147547 },   { 2036574990, 2121491044, 1228985367 }, { 1059346323, 1794217031, 440268843 },  { 1517280386, 1710623024, 2077581979 },
    //     { 1983704480, 437575685, 1350530467 },  { 1610893726, 964515153, 1399608915 },  { 1838648814, 2028420215, 355657380 },  { 1086596059, 219029525, 442255717 },
    //     { 550933352, 1734844847, 1151868210 },  { 2031411412, 1236581478, 2025648727 }, { 1019898798, 224627632, 40359598 },    { 1866414781, 539592538, 108344885 },
    //     { 2033833186, 1137147803, 1586150368 }, { 1714724765, 148582615, 1852012491 },  { 1145956619, 1459549237, 2085810225 }, { 689397947, 1037019664, 212213796 },
    //     { 1854415352, 728652153, 1504980277 },  { 1141121173, 1794586901, 214222992 },  { 1263234172, 1153394562, 1915005712 }, { 1163583995, 1370114383, 45288300 },
    //     { 951247062, 1741102766, 1102014140 },  { 1652679252, 1026698066, 683291617 },  { 1487146410, 2055029084, 894320087 },  { 599656856, 292023421, 1037503352 },
    //     { 1899107071, 243096936, 1216306758 },  { 570845913, 1397808642, 1646231561 },  { 34537779, 655866963, 122487090 },     { 1351187804, 1921338450, 223729211 },
    //     { 2120467027, 1198200824, 1207091049 }, { 301247334, 1444986559, 2144016837 },  { 1862866446, 1032268309, 1960568897 }, { 292372311, 458846641, 221718910 },
    //     { 545592825, 23437085, 917580194 },     { 690251451, 349475863, 273054896 },    { 61083433, 132075165, 1436690804 },    { 156215960, 1296623086, 1827640293 },
    //     { 1691801410, 1422811590, 963983785 },  { 1058841527, 1900045247, 978635439 },  { 348570900, 95727284, 423210585 },     { 434463231, 579123617, 934742715 },
    //     { 1377933200, 459643152, 723777405 },   { 1179469227, 2065236379, 649635392 },  { 615171996, 1209460114, 1463417143 },  { 521713310, 259870469, 1808718132 },
    //     { 1494621239, 982944914, 1910956874 },  { 1834240433, 951204746, 1029897754 },  { 773356658, 1234319362, 513487114 },   { 1588631352, 462949913, 465934710 },
    //     { 1239294008, 370500203, 1441819168 },  { 449283828, 560794344, 2112296572 },   { 1316317047, 2111561182, 1841519199 }, { 878857029, 557562337, 1479046098 },
    //     { 1204555061, 628569958, 903224513 },   { 2079972995, 1367321099, 343204346 },  { 94367380, 1189624174, 940738848 },    { 1223209122, 614760723, 739645744 },
    //     { 1590670572, 376382101, 1514631092 },  { 133611706, 1491531627, 595443558 },   { 346084286, 1252878726, 1055589047 },  { 922705062, 924562047, 2070137884 },
    //     { 1424851341, 886340490, 1778039838 },  { 1280609261, 1118739393, 1433648666 }, { 566610122, 1073829656, 402459004 },   { 1702475825, 439078147, 832605537 },
    //     { 597816507, 1573532483, 99328976 },    { 827305913, 1721349113, 1962333454 },  { 2031994399, 297425752, 1640167295 },  { 1191634173, 363053689, 842309896 },
    //     { 490221048, 1397883844, 762667928 },   { 1977460600, 723383228, 996987329 },   { 1698624609, 136200245, 2047433660 },  { 2087047739, 13459275, 724251990 },
    //     { 565884734, 1767135422, 546199544 },   { 1630628730, 1938245743, 916761258 },  { 1958779628, 284899286, 1561250639 },  { 1984290627, 1699013726, 233638723 },
    //     { 1165910745, 1821095987, 1223316465 }, { 271390877, 11203511, 1466332088 },    { 121070044, 1157215799, 1714026561 },  { 1298769869, 1401400175, 1879584576 },
    //     { 693521462, 1621459565, 303428525 },   { 1597041697, 81697626, 849949749 },    { 44211599, 35002531, 2024502886 },     { 1089101934, 1533081357, 989570393 },
    //     { 1596232783, 1518665557, 1368871904 }, { 637780217, 1081224942, 140979280 },   { 764296319, 1428540726, 616808422 },   { 795584485, 1155253173, 940426084 },
    //     { 261551868, 3220067, 432574894 },      { 1054098363, 1638582838, 331469138 },  { 429222048, 537390463, 1752776006 },   { 1873146943, 2017889628, 1609224372 },
    //     { 824969886, 1114448970, 191469656 },   { 1100005186, 100444079, 241489211 },   { 2112560094, 1450364007, 180988552 },  { 1037749312, 1737989497, 316909585 },
    //     { 539950535, 1830233170, 173128562 },   { 2078883496, 235980582, 1870829312 },  { 1720171057, 1490099085, 141030281 },  { 1621470126, 480927252, 1963360703 },
    //     { 2117099166, 429135819, 1235623307 },  { 954054259, 1677022511, 2141959149 },  { 1639042582, 1615935605, 1951513273 }, { 565838680, 993105844, 887015624 },
    //     { 240115094, 492612145, 782861830 },    { 2073955288, 1159450959, 625655035 },  { 1304237533, 954632202, 653092277 },   { 732979722, 1223988462, 828226221 },
    //     { 9096493, 413418914, 1222089553 },     { 1125517363, 1534357165, 957238979 },  { 1515520376, 47422365, 311255518 },    { 1326934, 826943268, 2068825539 },
    //     { 843105396, 975287666, 2064608558 },   { 835266080, 216406121, 1447861276 },   { 1067261575, 1681871281, 2030857953 }, { 524530653, 366314036, 1951870750 },
    //     { 131503678, 421643383, 2011786628 },   { 2115318428, 565043311, 510240943 },   { 717326530, 133795452, 284783355 },    { 1760281969, 1324331911, 1525910669 },
    //     { 730901409, 653520223, 1483017203 },   { 1374923739, 1419239653, 1059980742 }, { 1719478929, 594922024, 170596936 },   { 332034607, 1343124943, 1700303384 },
    //     { 434084259, 652192154, 636997990 },    { 819237635, 1409270528, 1012621333 },  { 318841256, 793290327, 1252045313 },   { 2080802285, 272812600, 283781855 },
    //     { 2107940645, 1120695956, 2105348302 }, { 500860095, 1967204072, 140608892 },   { 981636144, 1389295954, 307405047 },   { 1858453894, 2032434490, 1251584248 },
    //     { 774133771, 1410355671, 2070750558 },  { 984645024, 419934586, 1209322860 },   { 1304072812, 333650002, 575781297 },   { 594945297, 561746247, 931061117 },
    //     { 1778341377, 2053607940, 631472996 },  { 302460298, 356436037, 1288582376 },   { 1978897084, 1244049699, 842503901 },  { 1603379436, 1373378296, 1214782916 },
    //     { 729437183, 1814077605, 1376970776 },  { 1464052160, 457025794, 1830998086 },  { 144169892, 701821028, 1525828272 },   { 1493538677, 2115678203, 169330795 },
    //     { 526839290, 512870449, 1961760932 },   { 999551733, 1848889697, 200765389 },   { 567083486, 439723816, 946946185 },    { 323223378, 1429170783, 468758186 },
    //     { 1448814906, 2062535456, 352379118 },  { 1823421447, 1652617039, 2128567822 }, { 2056792628, 469433037, 2053617428 },  { 790937812, 368031354, 750063318 },
    //     { 585177736, 1754589339, 137579969 },   { 1614134811, 1750339573, 1726206805 }, { 2001184312, 15852470, 144491062 },    { 1804757924, 1507398440, 980997421 },
    //     { 1391696728, 2002508019, 788559549 },  { 1198754406, 1921209135, 197815653 },  { 382994415, 978642846, 473060349 },    { 740824449, 2073812684, 910189178 },
    //     { 1023497065, 571158985, 217158805 },   { 1213319382, 1901625009, 1759891609 }, { 1206002332, 1330533538, 529956955 },  { 1371858576, 1442652640, 1572545850 },
    //     { 696857321, 1852666956, 1408131639 }
    // };

    /* the key the hashing function will use */
    struct Key {
        BitBoard    p1;
        BitBoard    p2;

        bool operator==(const Key &other) const {
            return (p1 == other.p1 && p2 == other.p2);
        }
    };
    /* the hashing function that std::unordered_map will use */
    struct KeyHash {
        uint64_t operator()(const Key &k) const {
            uint64_t    hash = 0;
            for (int n = 0; n < SIZE; ++n)
                hash ^= _table[n][(!k.p1[n] ? (!k.p2[n] ? 0 : 2) : 1)];
                // hash ^= _table[n][(k.p1[n]<<(n&0x3F))^(k.p2[n]<<(n&0x3F-1))>>0x3F]; // maybe faster ?
                // hash ^= _table[n][k.p1[n]][k.p2[n]]; // could use a 3rd dimension to avoid branching (opti?)
            return (hash);
        }
    };
    // std::unordered_map<Key, t_stored, KeyHash>  map;
}

#endif

/*

⎪        root node
⎪   - - - - -△- - - - - ↑     ↑
⎪                       ⎪ 1   ⎪
⎪   - - -○- - - -○- - - ↓     ⎪ 2
⎪                             ⎪
⎪   -△- - - △-△ - - -△-       ↓


   iterative deepening :
       we iteratively explore the graph by calling MTD(f) at each depth and for a depth of 1,
       computing the evalutation score on each node we visit and returning it to be the next
       first guess for the MTD(f) algorithm.

   MTD(f) :
        we have a lower and upper bound, and we explore each node with a null window alpha-beta
        pruning with transposition table, the score returned will be the new value for the upper
        bound if that score is below beta otherwise for the lower bound. When lower and upper
        bound cross, we return the last score.

+*/
